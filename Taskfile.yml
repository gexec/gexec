---
version: "3"

vars:
  SOURCES:
    sh: find . -name "*.go" -type f -not -iname mock.go -not -path "./.devenv/*" -not -path "./.direnv/*" | xargs echo
  PACKAGES:
    sh: go list ./... | xargs echo

tasks:
  clean:
    desc: Remove all temporary build artifacts
    cmds:
      - go clean -i ./...
      - rm -rf bin/ frontend/static/

  build:
    desc: Build all required binary artifacts
    deps:
      - build:client
      - build:server
      - build:runner

  watch:
    desc: Start components with hot reloading
    deps:
      - watch:server
      - watch:runner
      - watch:frontend

  generate:
    desc: Generate code like openapi clients
    deps:
      - be:generate
      - fe:generate

  be:fmt:
    desc: Run standard formatter for backend
    cmds:
      - gofmt -s -w {{ .SOURCES }}

  be:vet:
    desc: Run vet linting for backend
    cmds:
      - go vet {{ .PACKAGES }}

  be:lint:
    desc: Run revive linting for backend
    cmds:
      - for PKG in {{ .PACKAGES }}; do go run github.com/mgechev/revive -config revive.toml -set_exit_status $PKG || exit 1; done;

  be:golangci:
    desc: Run golangci linter for backend
    cmds:
      - go run github.com/golangci/golangci-lint/cmd/golangci-lint run ./...

  be:staticcheck:
    desc: Run static checks for backend
    cmds:
      - go run honnef.co/go/tools/cmd/staticcheck -tags 'netgo' {{ .PACKAGES }}

  be:generate:
    desc: Generate code for backend
    cmds:
      - go generate {{ .PACKAGES }}

  be:test:
    desc: Run tests for backend
    cmds:
      - go test -coverprofile coverage.out {{ .PACKAGES }}

  fe:install:
    desc: Install dependencies for frontend
    dir: frontend/
    cmds:
      - npm install

  fe:fmt:
    desc: Run standard formatter for frontend
    dir: frontend/
    cmds:
      - npm run format

  fe:lint:
    desc: Run configured linters for frontend
    dir: frontend/
    cmds:
      - npm run lint

  fe:generate:
    desc: Generate code for frontend
    dir: frontend/
    cmds:
      - npm run openapi

  fe:test:
    desc: Run tests for frontend
    dir: frontend/
    cmds:
      - npm run test

  fe:build:
    desc: Build entire project for frontend
    dir: frontend/
    cmds:
      - npm run build

  build:release:
    desc: Generate a release with goreleaser
    cmds:
      - go run github.com/goreleaser/goreleaser/v2 release --clean

  build:snapshot:
    desc: Generate a snapshot with goreleaser
    cmds:
      - go run github.com/goreleaser/goreleaser/v2 release --clean --snapshot

  build:client:
    desc: Build client component
    cmds:
      - go build -v
          -tags 'netgo'
          -ldflags '-s -w -extldflags "-static" -X "{{ .IMPORT }}/pkg/version.String={{ .VERSION }}" -X "{{ .IMPORT }}/pkg/version.Revision={{ .REVISION }}" -X "{{ .IMPORT }}/pkg/version.Date={{ now | date "20060102" }}"'
          -o bin/genexec-client{{if eq OS "windows"}}.exe{{end}}
          ./cmd/genexec-client
    env:
      CGO_ENABLED: "0"
    vars:
      IMPORT: github.com/genexec/genexec
      VERSION:
        sh: if [[ -z "${CI_COMMIT_TAG}" ]]; then git rev-parse --short HEAD; else echo "${CI_COMMIT_TAG#v}"; fi
      REVISION:
        sh: git rev-parse --short HEAD

  build:server:
    desc: Build server component
    cmds:
      - go build -v
          -tags 'netgo'
          -ldflags '-s -w -extldflags "-static" -X "{{ .IMPORT }}/pkg/version.String={{ .VERSION }}" -X "{{ .IMPORT }}/pkg/version.Revision={{ .REVISION }}" -X "{{ .IMPORT }}/pkg/version.Date={{ now | date "20060102" }}"'
          -o bin/genexec-server{{if eq OS "windows"}}.exe{{end}}
          ./cmd/genexec-server
    env:
      CGO_ENABLED: "0"
    vars:
      IMPORT: github.com/genexec/genexec
      VERSION:
        sh: if [[ -z "${CI_COMMIT_TAG}" ]]; then git rev-parse --short HEAD; else echo "${CI_COMMIT_TAG#v}"; fi
      REVISION:
        sh: git rev-parse --short HEAD

  build:runner:
    desc: Build runner component
    cmds:
      - go build -v
          -tags 'netgo'
          -ldflags '-s -w -extldflags "-static" -X "{{ .IMPORT }}/pkg/version.String={{ .VERSION }}" -X "{{ .IMPORT }}/pkg/version.Revision={{ .REVISION }}" -X "{{ .IMPORT }}/pkg/version.Date={{ now | date "20060102" }}"'
          -o bin/genexec-runner{{if eq OS "windows"}}.exe{{end}}
          ./cmd/genexec-runner
    env:
      CGO_ENABLED: "0"
    vars:
      IMPORT: github.com/genexec/genexec
      VERSION:
        sh: if [[ -z "${CI_COMMIT_TAG}" ]]; then git rev-parse --short HEAD; else echo "${CI_COMMIT_TAG#v}"; fi
      REVISION:
        sh: git rev-parse --short HEAD

  watch:server:
    desc: Run reloading development server
    cmds:
      - task: build:server
      - bin/genexec-server start
    watch: true
    sources:
      - 'cmd/**/*.go'
      - 'pkg/**/*.go'
    env:
      GENEXEC_LOG_LEVEL: "{{ .GENEXEC_LOG_LEVEL | default \"debug\" }}"
      GENEXEC_ENCRYPT_PASSPHRASE: "aZRNei17y80b9iDR9fSqryhLzlk28OHZ"

  watch:runner:
    desc: Run reloading development runner
    cmds:
      - task: build:runner
      - bin/genexec-runner start
    watch: true
    sources:
      - 'cmd/**/*.go'
      - 'pkg/**/*.go'
    env:
      GENEXEC_LOG_LEVEL: "{{ .GENEXEC_LOG_LEVEL | default \"debug\" }}"
      GENEXEC_ENCRYPT_PASSPHRASE: "aZRNei17y80b9iDR9fSqryhLzlk28OHZ"

  watch:frontend:
    desc: Run reloading development frontend
    dir: frontend/
    cmds:
      - npm run serve

...
